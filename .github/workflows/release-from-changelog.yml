name: Release from Changelog

on:
  push:
    branches: [ main ]
    paths:
      - 'CHANGELOG.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  changelog_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract latest version and notes
        id: extract
        run: |
          set -euo pipefail
          # Ensure the top section is a version, not Unreleased
          TOP_LINE=$(grep -m1 -E '^## \[' CHANGELOG.md || true)
          if echo "$TOP_LINE" | grep -qE '^## \[Unreleased\]'; then
            echo "Top CHANGELOG section is [Unreleased]; skipping release." >&2
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          VERSION_LINE=$(grep -m1 -E '^## \[[0-9]+\.[0-9]+\.[0-9]+\]' CHANGELOG.md || true)
          if [ -z "${VERSION_LINE}" ]; then
            echo "No version section found; skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          VERSION=$(echo "$VERSION_LINE" | sed -E 's/^## \[([0-9]+\.[0-9]+\.[0-9]+)\].*/\1/')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

          awk -v v="$VERSION" '
            $0 ~ "^## \\[" v "\\]" {found=1; next}
            found && $0 ~ "^## \\[" { exit }
            found { print }
          ' CHANGELOG.md > RELEASE_NOTES.md

          if [ ! -s RELEASE_NOTES.md ]; then
            echo "No notes captured for $VERSION; skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

      - name: Verify package.json version matches
        if: steps.extract.outputs.skip != 'true'
        id: verify
        run: |
          set -euo pipefail
          FILE_VERSION="${{ steps.extract.outputs.version }}"
          PKG_VERSION=$(node -pe "require('./package.json').version")
          echo "CHANGELOG version: $FILE_VERSION"
          echo "package.json version: $PKG_VERSION"
          if [ "$FILE_VERSION" != "$PKG_VERSION" ]; then
            echo "Version mismatch: CHANGELOG ($FILE_VERSION) != package.json ($PKG_VERSION)" >&2
            exit 1
          fi

      - name: Create or update GitHub Release
        if: steps.extract.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.extract.outputs.version }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"
          TITLE="RunesSwap.app v${VERSION}"
          # Create or update the release; creating a release will also create the tag at this commit.
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release edit "$TAG" --title "$TITLE" --latest -F RELEASE_NOTES.md
          else
            gh release create "$TAG" --title "$TITLE" --latest -F RELEASE_NOTES.md --target "${GITHUB_SHA}"
          fi
